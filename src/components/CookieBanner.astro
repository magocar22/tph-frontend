---
// src/components/CookieBanner.astro
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 md:p-6 z-50 transform translate-y-full transition-transform duration-500 hidden">
  <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
    
    <div class="text-sm text-gray-600 flex-1">
      <p>
        Usamos cookies para mejorar tu experiencia y analizar el tr치fico de la web. 
        Puedes leer m치s en nuestra <a href="/cookies" class="text-blue-600 underline hover:text-blue-800">Pol칤tica de Cookies</a>.
      </p>
    </div>

    <div class="flex gap-3">
      <button id="cookie-reject" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
        Solo funcionales
      </button>
      <button id="cookie-accept" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm">
        Aceptar todas
      </button>
    </div>

  </div>
</div>

<script is:inline>
  // ==========================================
  // 游늸 ZONA DE CONFIGURACI칍N DE ANALYTICS
  // ==========================================
  
  // 1. Cuando tengas el ID (ej: 'G-12345678'), ponlo dentro de las comillas.
  // 2. Mientras est칠 vac칤o (""), Analytics NO se cargar치 nunca.
  const GA_ID = ""; 

  // ==========================================
  // 丘뙖잺 L칍GICA DEL BANNER (NO TOCAR)
  // ==========================================

  const banner = document.getElementById('cookie-banner');
  const btnAccept = document.getElementById('cookie-accept');
  const btnReject = document.getElementById('cookie-reject');

  // Funci칩n principal: Carga Google Analytics din치micamente
  function loadAnalytics() {
    if (!GA_ID) {
      console.warn("丘멆잺 Google Analytics no se carg칩: Falta el ID en CookieBanner.astro");
      return;
    }

    // Evitamos cargar el script dos veces
    if (document.getElementById('ga-script')) return;

    console.log("游 Cargando Google Analytics: " + GA_ID);

    // 1. Crear e inyectar el script de Google
    const script = document.createElement('script');
    script.id = 'ga-script';
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
    script.async = true;
    document.head.appendChild(script);
    
    // 2. Inicializar el dataLayer
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', GA_ID);
  }

  // Comprobar historial al entrar en la web
  const consent = localStorage.getItem('cookieConsent');
  
  if (!consent) {
    // Si no ha decidido, mostramos el banner
    banner.classList.remove('hidden');
    // Peque침o delay para que la animaci칩n de "deslizar hacia arriba" se vea suave
    setTimeout(() => banner.classList.remove('translate-y-full'), 100);
  } else if (consent === 'accepted') {
    // Si ya acept칩 anteriormente, cargamos Analytics directamente
    loadAnalytics();
  }

  // EVENTO: Click en ACEPTAR
  btnAccept.addEventListener('click', () => {
    localStorage.setItem('cookieConsent', 'accepted');
    closeBanner();
    loadAnalytics(); // Aqu칤 empieza la magia
  });

  // EVENTO: Click en RECHAZAR (Solo funcionales)
  btnReject.addEventListener('click', () => {
    localStorage.setItem('cookieConsent', 'rejected');
    closeBanner();
    // No cargamos analytics. Cumplimiento estricto RGPD.
  });

  function closeBanner() {
    banner.classList.add('translate-y-full');
    setTimeout(() => banner.classList.add('hidden'), 500);
  }
</script>