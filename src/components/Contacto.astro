---
// src/components/Contacto.astro
interface Props {
  simple?: boolean;
  tipo?: "Cliente" | "Inversor";
  asunto?: string;
}

const { simple = false, tipo = "Cliente", asunto } = Astro.props;

// =================================================================
// ⚙️ CONFIGURACIÓN: UN SOLO FORMULARIO PARA TODO
// =================================================================
const FORM_ID = "8079e0a"; // <--- PONE AQUÍ EL ID REAL DE TU ÚNICO FORMULARIO CF7

// Textos visuales según el tipo
const textoBoton =
  tipo === "Inversor" ? "Solicitar Dossier" : "Solicitar información";
const placeholderMensaje =
  tipo === "Inversor"
    ? "Estoy interesado en oportunidades de inversión..."
    : "Me gustaría saber más sobre cómo acceder a una vivienda...";

// Asunto/Etiqueta para que sepas de dónde viene
// En CF7 debes tener un campo hidden llamado "origen" o "your-subject" mapeado.
const etiquetaOrigen = asunto || `Perfil: ${tipo}`;
---

<div class={simple ? "w-full" : "py-16 md:py-24 bg-blue-50"} id="contacto">
  <div class={simple ? "" : "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"}>
    <div
      class={simple
        ? ""
        : "grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-start"}
    >
      <!-- Texto Ayuda (Oculto en Inversores) -->
      {
        !simple && tipo !== "Inversor" && (
          <div class="space-y-8">
            <div>
              <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                ¿Tienes dudas?
              </h2>
              <p class="text-gray-600 text-lg leading-relaxed">
                Estamos encantados de aclararte cualquier duda. Rellena el
                formulario y te contactaremos.
              </p>
            </div>
          </div>
        )
      }

      <!-- FORMULARIO -->
      <div
        class={simple
          ? ""
          : "bg-white rounded-3xl shadow-xl p-8 md:p-10 border border-gray-100"}
      >
        <form id="universal-form" class="space-y-4">
          <!-- ID DEL FORMULARIO (Para la API) -->
          <input type="hidden" name="_fid" value={FORM_ID} />

          <!-- LA ETIQUETA DE DIFERENCIACIÓN -->
          <!-- Asegúrate de que en CF7 tienes un campo [text* your-subject] o similar -->
          <input type="hidden" name="your-subject" value={etiquetaOrigen} />

          <!-- Campo extra por si quieres filtrar por "tipo" explícito en WP -->
          <input type="hidden" name="tipo-contacto" value={tipo} />

          <!-- CAMPO HONEY POT (Anti-Spam) -->
          <input type="text" name="_honey" style="display:none" tabindex="-1" autocomplete="off"/>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Nombre y apellidos</label
            >
            <input
              type="text"
              name="your-name"
              required
              placeholder="Tu nombre completo"
              class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none"
            />
          </div>

          <div
            class={simple
              ? "grid grid-cols-1 gap-4"
              : "grid grid-cols-1 md:grid-cols-2 gap-6"}
          >
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Email</label
              >
              <input
                type="email"
                name="your-email"
                required
                placeholder="tu@email.com"
                class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Teléfono</label
              >
              <input
                type="tel"
                name="your-phone"
                required
                placeholder="600 00 00 00"
                class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Mensaje</label
            >
            <textarea
              name="your-message"
              rows={simple ? "3" : "4"}
              required
              placeholder={placeholderMensaje}
              class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none resize-none"
            ></textarea>
          </div>

          <div class="flex items-start">
            <input
              type="checkbox"
              name="acceptance"
              value="1"
              required
              class="mt-1 w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
            />
            <span class="ml-2 text-xs text-gray-500"
              >Acepto la <a
                href="/politica-privacidad"
                target="_blank"
                class="text-blue-600 hover:underline">Política de Privacidad</a
              >.</span
            >
          </div>

          <button
            type="submit"
            id="btn-submit"
            class="w-full bg-blue-600 text-white font-bold py-3.5 px-6 rounded-xl hover:bg-blue-700 transition-all duration-200 shadow-md"
          >
            {textoBoton}
          </button>

          <div
            id="result"
            class="hidden text-center p-4 text-sm rounded-xl mt-4 font-medium border"
          >
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  const form = document.getElementById("universal-form");
  const result = document.getElementById("result");
  const btn = document.getElementById("btn-submit");

  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(form);

      // Estado: Cargando
      const textoOriginal = btn.innerHTML;
      btn.innerHTML = "Enviando...";
      btn.disabled = true;
      result.classList.add("hidden");

      try {
        // Enviamos a nuestra API Universal
        const response = await fetch("/api/forms", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success) {
          result.innerHTML = "✅ Mensaje recibido correctamente.";
          result.className =
            "text-center p-4 text-sm rounded-xl mt-4 font-medium border bg-green-50 border-green-200 text-green-700 block";
          form.reset();
        } else {
          throw new Error(data.message || "Error al enviar");
        }
      } catch (error) {
        console.error(error);
        result.innerHTML = "❌ Hubo un error. Inténtalo más tarde.";
        result.className =
          "text-center p-4 text-sm rounded-xl mt-4 font-medium border bg-red-50 border-red-200 text-red-700 block";
      } finally {
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
      }
    });
  }
</script>
