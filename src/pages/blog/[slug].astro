---
// src/pages/blog/[slug].astro
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import imgCabecera from '../../assets/fondo-salon.webp';
import { sanitizeWPHtml, sanitizeWPText } from "../../lib/sanitize";
import { fetchWP } from '../../lib/wordpress';

export const prerender = true;

export async function getStaticPaths() {
  try {
    const posts = await fetchWP<any[]>({
      endpoint: "posts",
      params: { per_page: "100", _embed: "true" },
    });
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error("[getStaticPaths] WP no disponible.", error);
    return [];
  }
}

const { post } = Astro.props;
if (!post) return Astro.redirect('/blog');

// Datos y Sanitización
const titulo = sanitizeWPText(post.title.rendered);
const contenido = sanitizeWPHtml(post.content.rendered);
const fecha = new Date(post.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
const fechaISO = post.date;

// Categoría e Imagen
const categoria = post._embedded?.['wp:term']?.[0]?.[0]?.name ?? "Actualidad";
const imagenUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url ?? null;

// SEO Mapping
const yoast = post.yoast_head_json;
const seoTitle = yoast?.title || titulo;
const cleanExcerpt = (post.excerpt?.rendered || "").replace(/<[^>]*>?/gm, '').trim();
const cleanContent = (post.content?.rendered || "").replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim();
const buildFallbackDescription = (text: string, max = 160) => {
  if (!text) return "";
  if (text.length <= max) return text;
  const sliced = text.slice(0, max + 1);
  const lastSpace = sliced.lastIndexOf(" ");
  return (lastSpace > 80 ? sliced.slice(0, lastSpace) : sliced.slice(0, max)).trim();
};
const seoDesc = yoast?.description || cleanExcerpt || buildFallbackDescription(cleanContent) || "Lee la noticia completa en Tu Primer Hogar.";
const seoImage = yoast?.og_image?.[0]?.url || imagenUrl || '/img/social-preview.webp';
---

<Layout 
    title={seoTitle} 
    description={seoDesc} 
    image={seoImage}
    jsonLd={yoast?.schema}
    type="article"          
    publishDate={fechaISO}
    navbarTransparent={false} 
>
    <!-- Contenedor con padding superior para que el Navbar fixed no tape el título -->
    <main class="max-w-4xl mx-auto px-4 py-24 md:py-32">
        
        <div class="text-center mb-12">
            <span class="text-blue-600 font-bold tracking-widest text-xs uppercase mb-4 block">
                {categoria} — {fecha}
            </span>
            <h1 class="text-3xl md:text-5xl font-bold text-gray-900 leading-tight mb-8">{titulo}</h1>
            
            <div class="rounded-3xl overflow-hidden shadow-xl mb-12 aspect-video bg-gray-100 relative">
                {imagenUrl ? (
                    <Image 
                        src={imagenUrl} 
                        alt={titulo} 
                        inferSize={true} 
                        width={1200}
                        height={675}
                        format="webp"
                        quality={80}
                        class="w-full h-full object-cover absolute inset-0"
                        loading="eager"
                        fetchpriority="high"
                    />
                ) : (
                    <Image 
                        src={imgCabecera} 
                        alt="Imagen corporativa"
                        class="w-full h-full object-cover opacity-50 absolute inset-0"
                    />
                )}
            </div>
        </div>

        <article 
            class="prose prose-blue prose-lg mx-auto text-gray-600 max-w-none prose-img:rounded-2xl" 
            set:html={contenido}
        />

        <div class="mt-16 pt-8 border-t border-gray-100 text-center">
            <a href="/blog" class="inline-flex items-center text-gray-500 hover:text-blue-600 font-medium transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Volver a Actualidad
            </a>
        </div>
    </main>
</Layout>
