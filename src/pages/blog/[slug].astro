---
// src/pages/blog/[slug].astro
import { Image } from 'astro:assets';
import BaseHead from '../../components/BaseHead.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import imgCabecera from '../../assets/fondo-salon.webp';

// 1. IMPORTAMOS LA CONEXI√ìN A WORDPRESS
import { fetchWP } from '../../lib/wordpress';

// 2. FORZAMOS MODO EST√ÅTICO
export const prerender = true;

// 3. GENERAMOS LAS RUTAS
export async function getStaticPaths() {
    const posts = await fetchWP<any[]>({
        endpoint: 'posts',
        params: { 
            per_page: '100', 
            _embed: 'true'
        }
    });

    return posts.map(post => ({
        params: { slug: post.slug }, 
        props: { post }, 
    }));
}

// 4. RECUPERAMOS DATOS
const { post } = Astro.props;

if (!post) {
    return Astro.redirect('/blog');
}

// 5. EXTRACCI√ìN DE DATOS B√ÅSICOS
const titulo = post.title.rendered;
const contenido = post.content.rendered;
const fecha = new Date(post.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

// Categor√≠a
let categoria = "Actualidad";
if (post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0] && post._embedded['wp:term'][0][0]) {
    categoria = post._embedded['wp:term'][0][0].name;
}

// Imagen destacada (para el cuerpo de la noticia)
let imagenUrl = null;
if (post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
    imagenUrl = post._embedded['wp:featuredmedia'][0].source_url.replace('http:', 'https:');
}

// ============================================================
// üìç MAPEO SEO (YOAST -> ASTRO)
// ============================================================
const yoast = post.yoast_head_json;

// A. T√≠tulo SEO
const seoTitle = yoast?.title || titulo;

// B. Descripci√≥n SEO
// Limpiamos el excerpt de etiquetas HTML
const cleanExcerpt = post.excerpt.rendered.replace(/<[^>]*>?/gm, '');
const seoDesc = yoast?.description || cleanExcerpt;

// C. Imagen SEO (Open Graph)
// Si Yoast tiene imagen espec√≠fica la usamos, si no, la destacada, si no, la de cabecera por defecto
const seoImage = yoast?.og_image?.[0]?.url || imagenUrl || '/img/social-preview.jpg';
// ============================================================

---

<html lang="es">
<head>
    <!-- PASAMOS LOS DATOS MAPEADOS AL HEAD -->
    <BaseHead 
        title={seoTitle} 
        description={seoDesc} 
        image={seoImage}
    />
</head>
<body class="bg-white font-sans text-gray-800">
    
    <!-- Navbar Blanco -->
    <div class="pt-20"> 
        <Navbar />
    </div>

    <main class="max-w-4xl mx-auto px-4 py-12">
        
        <!-- ENCABEZADO -->
        <div class="text-center mb-12">
            <span class="text-blue-600 font-bold tracking-widest text-xs uppercase mb-4 block">
                {categoria} ‚Äî {fecha}
            </span>
            
            <h1 class="text-3xl md:text-5xl font-bold text-gray-900 leading-tight mb-8" set:html={titulo}></h1>
            
            <!-- IMAGEN PRINCIPAL -->
            <div class="rounded-3xl overflow-hidden shadow-xl mb-12 aspect-video bg-gray-100 relative">
                {imagenUrl ? (
                    <img 
                        src={imagenUrl} 
                        alt={titulo} 
                        class="w-full h-full object-cover absolute inset-0"
                        loading="eager"
                        fetchpriority="high"
                    />
                ) : (
                    <img 
                        src={imgCabecera.src} 
                        alt="Imagen por defecto"
                        class="w-full h-full object-cover opacity-50 absolute inset-0"
                        loading="eager"
                        fetchpriority="high"
                    />
                )}
            </div>
        </div>

        <!-- CONTENIDO WORDPRESS -->
        <article 
            class="prose prose-blue prose-lg mx-auto text-gray-600 max-w-none" 
            set:html={contenido}
        />

        <!-- BOT√ìN VOLVER -->
        <div class="mt-16 pt-8 border-t border-gray-100 text-center">
            <a href="/blog" class="inline-flex items-center text-gray-500 hover:text-blue-600 font-medium transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Volver a Actualidad
            </a>
        </div>

    </main>

    <Footer />
</body>
</html>