---
import Layout from "../../layouts/Layout.astro";
import { WP_URL } from '../../lib/wordpress'; 
import { sanitizeWPText } from '../../lib/sanitize';

// 1. SEGURIDAD: Restauramos los nombres de cookies ORIGINALES que te funcionan
const token = Astro.cookies.get('wp_jwt')?.value;
const username = Astro.cookies.get('wp_user_display')?.value || "Inversor";

// Si no hay token, redirigimos
if (!token) {
    return Astro.redirect('/inversores');
}

let misProyectosCompletos = [];
const baseUrl = WP_URL.replace(/\/$/, '');
const REQUEST_TIMEOUT_MS = 8000;
const ALLOWED_DOC_HOSTS = new Set<string>([
    new URL(baseUrl).hostname,
    "admin.tuprimerhogar.es",
]);

function getSafeDocUrl(rawUrl: string | null | undefined): string | null {
    if (!rawUrl) return null;

    try {
        const parsed = new URL(rawUrl, baseUrl);
        const isHttp = parsed.protocol === "https:" || parsed.protocol === "http:";
        const isAllowedHost = ALLOWED_DOC_HOSTS.has(parsed.hostname);
        if (!isHttp || !isAllowedHost) return null;
        return parsed.toString();
    } catch {
        return null;
    }
}

async function fetchWithTimeout(url: string, options: RequestInit = {}, timeoutMs = REQUEST_TIMEOUT_MS) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), timeoutMs);

    try {
        return await fetch(url, { ...options, signal: controller.signal });
    } finally {
        clearTimeout(timeout);
    }
}

try {
    // 2. RECUPERAR DATOS
    const resUser = await fetchWithTimeout(`${baseUrl}/wp-json/wp/v2/users/me?context=edit`, {
        headers: { 
            'Authorization': `Bearer ${token}`
        }
    });

    if (!resUser.ok) {
        throw new Error("Sesi√≥n caducada");
    }

    const user = await resUser.json();
    
    // Si el usuario tiene proyectos asignados
    if (user.acf && user.acf.proyectos_asignados && user.acf.proyectos_asignados.length > 0) {
        const ids = user.acf.proyectos_asignados.map((p: any) => (typeof p === 'object' ? p.ID : p)).join(',');

        const resProyectos = await fetchWithTimeout(`${baseUrl}/wp-json/wp/v2/proyectos?include=${ids}&acf_format=standard&_embed=true`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (resProyectos.ok) {
            misProyectosCompletos = await resProyectos.json();
        }
    }

} catch (error) {
    console.error("Error en Dashboard:", error);
    // Borramos la cookie correcta si falla
    Astro.cookies.delete('wp_jwt', { path: '/' });
    return Astro.redirect('/inversores'); 
}

// 3. HELPERS VISUALES (Originales)
const getFileStyle = (mimeType: string, filename: string) => {
    if (!mimeType) return 'bg-gray-50 text-gray-600';
    const name = filename ? filename.toLowerCase() : '';
    
    if (mimeType.includes('pdf')) return 'bg-red-50 text-red-600';
    if (mimeType.includes('sheet') || mimeType.includes('excel') || name.endsWith('.csv')) return 'bg-green-50 text-green-600';
    if (mimeType.includes('image')) return 'bg-blue-50 text-blue-600';
    if (name.endsWith('.zip') || name.endsWith('.rar')) return 'bg-yellow-50 text-yellow-600';
    
    return 'bg-gray-50 text-gray-600';
};

const getExtension = (filename: string) => filename ? filename.split('.').pop()?.toUpperCase() : 'FILE';
const getSize = (bytes: number) => bytes ? (bytes > 1000000 ? (bytes/1000000).toFixed(2) + ' MB' : Math.round(bytes/1000) + ' KB') : '-';
---

<Layout 
    title="Mi Panel | Inversores" 
    description="Panel privado de inversores"
    navbarTransparent={false} 
>
    <head>
        <meta name="robots" content="noindex, nofollow" />
    </head>
    <!-- Contenedor gris para mantener tu dise√±o original -->
    <div class="bg-gray-50 min-h-screen pt-12 pb-24">
        
        <div class="max-w-5xl mx-auto px-4 mt-20"> <!-- Margen superior para el Navbar fixed -->
            
            <!-- HEADER DASHBOARD -->
            <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4 border-b border-gray-200 pb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Hola, {username} üëã</h1>
                    <p class="text-gray-500 mt-2">Aqu√≠ tienes la documentaci√≥n actualizada de tus inversiones.</p>
                </div>
                
                <!-- Bot√≥n Logout -->
                <a href="/api/logout" class="px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-red-600 text-sm font-bold hover:bg-red-50 transition-colors shadow-sm cursor-pointer">
                    Cerrar Sesi√≥n
                </a>
            </div>

            <!-- LISTA DE PROYECTOS -->
            {misProyectosCompletos.length === 0 ? (
                <div class="bg-white p-12 rounded-3xl border border-gray-200 text-center shadow-sm">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4 text-gray-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Sin proyectos asignados</h3>
                    <p class="text-gray-500 mt-2">Actualmente no tienes inversiones activas vinculadas a tu cuenta.</p>
                </div>
            ) : (
                <div class="space-y-10">
                    {misProyectosCompletos.map((proyecto: any) => {
                        
                        const acf = proyecto.acf || {};
                        const docs = [];
                        if (acf.documento_1) docs.push(acf.documento_1);
                        if (acf.documento_2) docs.push(acf.documento_2);
                        if (acf.documento_3) docs.push(acf.documento_3);
                        
                        const titulo = sanitizeWPText(proyecto?.title?.rendered);
                        const ubicacion = acf.ubicacion || '';
                        const estado = acf.estado || 'En Curso';
                        const linkFicha = `/proyectos/${proyecto.slug}`;

                        return (
                        <article class="bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
                            
                            <!-- CABECERA TARJETA -->
                            <div class="p-8 border-b border-gray-100 bg-white">
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div>
                                        <span class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2 block flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-blue-600 animate-pulse"></span>
                                            Inversi√≥n Activa
                                        </span>
                                        <h2 class="text-2xl font-bold text-gray-900">{titulo}</h2>
                                        
                                        {ubicacion && (
                                            <p class="text-sm text-gray-500 mt-1 flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                                {ubicacion}
                                            </p>
                                        )}
                                    </div>
                                    <div class="flex flex-col items-end gap-3">
                                        <span class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 uppercase border border-gray-200">
                                            {estado}
                                        </span>
                                        <a href={linkFicha} target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-blue-600 hover:text-blue-800 flex items-center group">
                                            Ver ficha del proyecto 
                                            <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ZONA DOCUMENTOS -->
                            <div class="p-8 bg-gray-50/50">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Documentaci√≥n Privada
                                </h3>

                                {docs.length > 0 ? (
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {docs.map((doc: any) => {
                                            const safeUrl = getSafeDocUrl(doc?.url);
                                            if (!safeUrl || !doc?.filename) return null;
                                            const iconClass = getFileStyle(doc.mime_type, doc.filename);
                                            const docTitle = sanitizeWPText(doc?.title);
                                            return (
                                                <a
                                                    class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all group cursor-pointer"
                                                    href={safeUrl}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    <div class="flex items-center gap-3 overflow-hidden">
                                                        <div class={`w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg ${iconClass} bg-opacity-20`}>
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                                        </div>
                                                        <div class="min-w-0 flex-1">
                                                            <p class="font-bold text-gray-900 text-sm truncate group-hover:text-blue-600 transition-colors" title={docTitle}>{docTitle}</p>
                                                            <div class="flex items-center text-xs text-gray-400 mt-0.5">
                                                                <span class="font-semibold">{getExtension(doc.filename)}</span>
                                                                <span class="mx-1.5">‚Ä¢</span>
                                                                <span>{getSize(doc.filesize)}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="text-gray-300 group-hover:text-blue-500 transition-colors">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                                    </div>
                                                </a>
                                            )
                                        })}
                                    </div>
                                ) : (
                                    <div class="text-center py-6 border-2 border-dashed border-gray-200 rounded-xl bg-white opacity-75">
                                        <p class="text-gray-400 text-sm">No hay documentos disponibles para descargar.</p>
                                    </div>
                                )}
                            </div>

                        </article>
                        );
                    })}
                </div>
            )}
        </div>
    </div>
</Layout>
